# Подготовка данных для проекта R-PKM

Этот набор скриптов предназначен для подготовки данных NSD (Natural Scenes Dataset) для обучения модели R-PKM в проекте DREAM.

## Содержание

1. [Обзор](#обзор)
2. [Требования](#требования)
3. [Подготовка окружения](#подготовка-окружения)
4. [Обработка данных](#обработка-данных)
5. [Обучение модели](#обучение-модели)
6. [Устранение неполадок](#устранение-неполадок)

## Обзор

Скрипты в этом репозитории выполняют следующие задачи:

1. `prepare_rpkm_environment.py` - Устанавливает необходимые зависимости и проверяет наличие CUDA
2. `prepare_rpkm_data.py` - Обрабатывает данные из директории `nsd_data` и подготавливает их для обучения R-PKM

Результатом работы скриптов будет создание директорий с обработанными данными в формате, подходящем для обучения модели.

## Требования

- Python 3.7 или выше
- CUDA-совместимая видеокарта (для ускорения обучения, не обязательно)
- Данные NSD в директории `nsd_data`

## Подготовка окружения

1. Запустите скрипт подготовки окружения:

```bash
python prepare_rpkm_environment.py
```

Скрипт установит все необходимые зависимости, проверит доступность CUDA и создаст необходимые директории.

Опции скрипта:
- `--skip_deps` - Пропустить установку зависимостей
- `--cuda_check` - Принудительно проверить доступность CUDA
- `--download_midas` - Скачать модель MiDaS для оценки глубины

## Обработка данных

После подготовки окружения запустите скрипт обработки данных:

```bash
python prepare_rpkm_data.py --data_path nsd_data --output_path data/processed_depth_data --subject_id 1
```

Скрипт выполнит следующие операции:
1. Загрузит fMRI данные из директории `nsd_data`
2. Обработает изображения и изменит их размер до 64x64
3. Сгенерирует карты глубины с помощью MiDaS
4. Сохранит все данные в структуре, необходимой для обучения модели R-PKM

### Структура выходных данных

```
data/
└── processed_depth_data/
    └── subj01/
        ├── fmri_data.npy                # fMRI данные
        ├── nsd_train_stim_sub1.npy      # RGB изображения
        └── nsd_train_depth_sub1.npy     # Карты глубины
```

## Обучение модели

После обработки данных вы можете начать обучение моделей R-PKM:

1. Обучение энкодера:
```bash
python src/r-pkm/train_encoder.py --mode rgbd
```

2. Обучение декодера:
```bash
python src/r-pkm/train_decoder.py --mode rgbd
```

Доступные режимы обучения:
- `rgb` - Обучение только для RGB изображений
- `depth` - Обучение только для карт глубины
- `rgbd` - Обучение для RGB изображений и карт глубины одновременно

## Устранение неполадок

### Проблемы с данными

Если у вас возникают проблемы с данными, проверьте:
1. Структуру директории `nsd_data`
2. Наличие fMRI данных и изображений
3. Формат данных

### Ошибки CUDA

Если вы видите ошибки, связанные с CUDA:
1. Убедитесь, что ваши драйверы NVIDIA обновлены
2. Проверьте версию CUDA, совместимую с установленной версией PyTorch
3. При необходимости, добавьте параметр `--device cpu` при запуске обучения

### Ошибки MiDaS

Если MiDaS не удается скачать или загрузить:
1. Проверьте ваше интернет-соединение
2. Убедитесь, что PyTorch установлен правильно
3. Попробуйте запустить `prepare_rpkm_environment.py` с параметром `--download_midas`

Если проблемы не устраняются, скрипт автоматически сгенерирует случайные карты глубины, которые можно использовать для тестирования работоспособности кода. 